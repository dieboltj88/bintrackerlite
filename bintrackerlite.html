<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bin Tracker Lite</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0b1320;
      color: #f5f7ff;
    }

    .app {
      max-width: 960px;
      margin: 0 auto;
      padding: 12px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 8px 0 12px;
    }

    .title-group {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    h1 {
      margin: 0;
      font-size: 1.3rem;
    }

    .subtitle {
      font-size: 0.75rem;
      opacity: 0.7;
    }

    button, input, textarea {
      font-family: inherit;
      font-size: 1rem;
    }

    button {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #4b5cff;
      background: #4b5cff;
      color: #fff;
      cursor: pointer;
    }

    button.secondary {
      background: transparent;
      border-color: #64748b;
      color: #e2e8f0;
    }

    button.danger {
      background: transparent;
      border-color: #f97373;
      color: #fecaca;
    }

    button.small {
      padding: 4px 8px;
      font-size: 0.8rem;
    }

    button:disabled {
      opacity: 0.5;
      cursor: default;
    }

    main {
      display: block;
    }

    .view {
      display: none;
    }

    .view.active {
      display: block;
    }

    .card {
      background: #111827;
      border-radius: 10px;
      padding: 10px 10px 8px;
      margin-bottom: 10px;
      border: 1px solid #1f2937;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .card-title {
      font-weight: 600;
      font-size: 0.95rem;
    }

    .muted {
      font-size: 0.8rem;
      opacity: 0.7;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 8px 0;
    }

    .row > * {
      flex: 1 1 140px;
    }

    label {
      font-size: 0.8rem;
      opacity: 0.8;
      display: block;
      margin-bottom: 2px;
    }

    input[type="text"],
    input[type="number"],
    textarea {
      width: 100%;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
    }

    textarea {
      min-height: 60px;
      resize: vertical;
    }

    .search-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
    }

    .search-row input {
      flex: 1 1 auto;
    }

    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      background: #1d283a;
      font-size: 0.7rem;
      opacity: 0.85;
    }

    .chip-list {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 4px;
    }

    .chip {
      font-size: 0.75rem;
      background: #0f172a;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      opacity: 0.85;
    }

    .section-title {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      opacity: 0.7;
      margin: 10px 0 4px;
    }

    .item-row {
      border-top: 1px solid #111827;
      padding-top: 6px;
      margin-top: 6px;
      display: flex;
      justify-content: space-between;
      gap: 6px;
      align-items: center;
    }

    .item-main {
      flex: 1 1 auto;
    }

    .item-name {
      font-size: 0.9rem;
    }

    .item-notes {
      font-size: 0.75rem;
      opacity: 0.7;
    }

    .item-qty {
      font-size: 0.8rem;
      opacity: 0.8;
      margin-top: 2px;
    }

    .item-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .qr-box {
      margin-top: 10px;
      padding: 10px;
      border-radius: 8px;
      background: #020617;
      border: 1px dashed #1e293b;
      text-align: center;
    }

    #qr-code {
      margin: 8px auto;
    }

    .url-preview {
      font-size: 0.72rem;
      word-break: break-all;
      opacity: 0.7;
      margin-top: 4px;
    }

    .inline-form-actions {
      display: flex;
      gap: 6px;
      margin-top: 8px;
    }

    .back-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }

    .pill {
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 0.7rem;
      border: 1px solid #1f2937;
      opacity: 0.8;
    }

    @media (max-width: 600px) {
      header {
        flex-direction: column;
        align-items: flex-start;
      }

      .back-row {
        flex-direction: column;
        align-items: flex-start;
      }

      .item-actions {
        flex-direction: row;
      }
    }
  </style>
  <!-- QRCode.js via CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
  <div class="app">
    <header>
      <div class="title-group">
        <h1>Bin Tracker Lite</h1>
        <div class="subtitle">LocalStorage • QR per bin • v0.1</div>
      </div>
      <button id="add-bin-btn">+ New Bin</button>
    </header>

    <main>
      <!-- BIN LIST VIEW -->
      <section id="view-list" class="view active">
        <div class="card">
          <div class="search-row">
            <input id="search-input" type="text" placeholder="Search bins or contents..." />
            <span id="bin-count" class="pill">0 bins</span>
          </div>
          <div class="muted" style="font-size:0.75rem;">
            Data is stored only in this browser using localStorage.
          </div>
        </div>

        <div id="bins-container"></div>

        <div id="empty-state" class="card" style="display:none;">
          <div class="card-title">No bins yet</div>
          <p class="muted">Tap “New Bin” to start adding your storage bins.</p>
        </div>
      </section>

      <!-- BIN DETAIL VIEW -->
      <section id="view-detail" class="view">
        <div class="back-row">
          <div>
            <button id="back-to-list" class="secondary small">&larr; All Bins</button>
          </div>
          <div class="muted" style="font-size:0.75rem;">
            Scanning a QR with <code>?bin=ID</code> will jump directly to this view.
          </div>
        </div>

        <div id="bin-detail-card" class="card" style="display:none;"></div>
      </section>
    </main>
  </div>

  <script>
    // --- Storage & State -----------------------------------------------------

    const STORAGE_KEY = "bin_tracker_v1";

    let bins = [];
    let currentBinId = null;

    function loadBins() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) {
          bins = [];
          return;
        }
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed)) {
          bins = parsed;
        } else {
          bins = [];
        }
      } catch (e) {
        console.error("Failed to parse bins from localStorage", e);
        bins = [];
      }
    }

    function saveBins() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(bins));
    }

    function genId() {
      if (window.crypto && window.crypto.randomUUID) {
        return crypto.randomUUID();
      }
      return "bin_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 8);
    }

    function findBin(id) {
      return bins.find(b => b.id === id) || null;
    }

    function upsertBin(bin) {
      const idx = bins.findIndex(b => b.id === bin.id);
      if (idx === -1) {
        bins.push(bin);
      } else {
        bins[idx] = bin;
      }
      saveBins();
    }

    function deleteBin(id) {
      bins = bins.filter(b => b.id !== id);
      saveBins();
    }

    // --- Views switching -----------------------------------------------------

    function showView(viewId) {
      document.querySelectorAll(".view").forEach(v => {
        v.classList.toggle("active", v.id === viewId);
      });
    }

    // --- Render list view ----------------------------------------------------

    function renderBinList(filterText = "") {
      const container = document.getElementById("bins-container");
      const emptyState = document.getElementById("empty-state");
      const binCount = document.getElementById("bin-count");

      const term = filterText.trim().toLowerCase();

      const filtered = bins.filter(bin => {
        if (!term) return true;
        const binText = (bin.name || "") + " " + (bin.location || "") + " " + (bin.notes || "");
        const inBin = binText.toLowerCase().includes(term);
        const inItems = (bin.items || []).some(item =>
          (item.name || "").toLowerCase().includes(term) ||
          (item.notes || "").toLowerCase().includes(term)
        );
        return inBin || inItems;
      });

      binCount.textContent = `${bins.length} bin${bins.length === 1 ? "" : "s"}`;

      container.innerHTML = "";

      if (filtered.length === 0) {
        emptyState.style.display = bins.length === 0 ? "block" : "block";
      } else {
        emptyState.style.display = "none";
      }

      filtered.forEach(bin => {
        const card = document.createElement("div");
        card.className = "card";

        const header = document.createElement("div");
        header.className = "card-header";

        const left = document.createElement("div");
        const title = document.createElement("div");
        title.className = "card-title";
        title.textContent = bin.name || "(Untitled bin)";
        left.appendChild(title);

        const meta = document.createElement("div");
        meta.className = "muted";
        meta.style.fontSize = "0.75rem";
        meta.textContent = bin.location ? bin.location : "No location set";
        left.appendChild(meta);

        if (bin.items && bin.items.length) {
          const chipList = document.createElement("div");
          chipList.className = "chip-list";
          const sample = bin.items.slice(0, 3);
          sample.forEach(item => {
            const c = document.createElement("span");
            c.className = "chip";
            c.textContent = item.name || "(unnamed item)";
            chipList.appendChild(c);
          });
          if (bin.items.length > 3) {
            const more = document.createElement("span");
            more.className = "chip";
            more.textContent = `+${bin.items.length - 3} more`;
            chipList.appendChild(more);
          }
          left.appendChild(chipList);
        } else {
          const emptyChip = document.createElement("div");
          emptyChip.className = "chip-list";
          const c = document.createElement("span");
          c.className = "chip";
          c.textContent = "No items yet";
          emptyChip.appendChild(c);
          left.appendChild(emptyChip);
        }

        header.appendChild(left);

        const right = document.createElement("div");
        right.style.display = "flex";
        right.style.flexDirection = "column";
        right.style.gap = "4px";

        const openBtn = document.createElement("button");
        openBtn.className = "small";
        openBtn.textContent = "Open";
        openBtn.addEventListener("click", () => openBinDetail(bin.id));
        right.appendChild(openBtn);

        const delBtn = document.createElement("button");
        delBtn.className = "small danger";
        delBtn.textContent = "Delete";
        delBtn.addEventListener("click", () => {
          if (confirm(`Delete bin "${bin.name || "(Untitled bin)"}"?`)) {
            deleteBin(bin.id);
            renderBinList(document.getElementById("search-input").value);
          }
        });
        right.appendChild(delBtn);

        header.appendChild(right);
        card.appendChild(header);

        container.appendChild(card);
      });
    }

    // --- Detail view rendering ----------------------------------------------

    function renderBinDetail() {
      const card = document.getElementById("bin-detail-card");
      const bin = findBin(currentBinId);
      if (!bin) {
        card.style.display = "block";
        card.innerHTML = "<div class='muted'>Bin not found. It may have been deleted.</div>";
        return;
      }

      card.style.display = "block";
      card.innerHTML = "";

      // BIN EDIT FORM
      const title = document.createElement("div");
      title.className = "section-title";
      title.textContent = "Bin Info";
      card.appendChild(title);

      const formRow1 = document.createElement("div");
      formRow1.className = "row";

      const nameCol = document.createElement("div");
      const nameLabel = document.createElement("label");
      nameLabel.textContent = "Bin name / label";
      const nameInput = document.createElement("input");
      nameInput.type = "text";
      nameInput.value = bin.name || "";
      nameInput.placeholder = "e.g. Bin 01 – Camping gear";
      nameCol.appendChild(nameLabel);
      nameCol.appendChild(nameInput);
      formRow1.appendChild(nameCol);

      const locCol = document.createElement("div");
      const locLabel = document.createElement("label");
      locLabel.textContent = "Location (optional)";
      const locInput = document.createElement("input");
      locInput.type = "text";
      locInput.value = bin.location || "";
      locInput.placeholder = "e.g. Garage loft (left)";
      locCol.appendChild(locLabel);
      locCol.appendChild(locInput);
      formRow1.appendChild(locCol);

      card.appendChild(formRow1);

      const notesLabel = document.createElement("label");
      notesLabel.textContent = "Notes (optional)";
      const notesInput = document.createElement("textarea");
      notesInput.value = bin.notes || "";
      card.appendChild(notesLabel);
      card.appendChild(notesInput);

      const binActions = document.createElement("div");
      binActions.className = "inline-form-actions";

      const saveBinBtn = document.createElement("button");
      saveBinBtn.textContent = "Save Bin Info";
      saveBinBtn.addEventListener("click", () => {
        bin.name = nameInput.value.trim() || "(Untitled bin)";
        bin.location = locInput.value.trim();
        bin.notes = notesInput.value.trim();
        bin.updatedAt = Date.now();
        upsertBin(bin);
        renderBinList(document.getElementById("search-input").value);
        renderBinDetail();
      });

      const delBinBtn = document.createElement("button");
      delBinBtn.className = "danger";
      delBinBtn.textContent = "Delete Bin";
      delBinBtn.addEventListener("click", () => {
        if (confirm(`Really delete bin "${bin.name || "(Untitled bin)"}" and all its items?`)) {
          deleteBin(bin.id);
          currentBinId = null;
          showView("view-list");
          renderBinList(document.getElementById("search-input").value);
        }
      });

      binActions.appendChild(saveBinBtn);
      binActions.appendChild(delBinBtn);
      card.appendChild(binActions);

      // ITEMS
      const itemsTitle = document.createElement("div");
      itemsTitle.className = "section-title";
      itemsTitle.textContent = "Contents";
      card.appendChild(itemsTitle);

      if (!bin.items) bin.items = [];

      if (bin.items.length === 0) {
        const empty = document.createElement("div");
        empty.className = "muted";
        empty.style.fontSize = "0.8rem";
        empty.textContent = "No items in this bin yet.";
        card.appendChild(empty);
      } else {
        bin.items.forEach(item => {
          const row = document.createElement("div");
          row.className = "item-row";

          const main = document.createElement("div");
          main.className = "item-main";

          const nm = document.createElement("div");
          nm.className = "item-name";
          nm.textContent = item.name || "(unnamed item)";
          main.appendChild(nm);

          if (item.notes) {
            const nt = document.createElement("div");
            nt.className = "item-notes";
            nt.textContent = item.notes;
            main.appendChild(nt);
          }

          const qty = document.createElement("div");
          qty.className = "item-qty";
          qty.textContent = `Qty: ${item.quantity || 1}`;
          main.appendChild(qty);

          row.appendChild(main);

          const actions = document.createElement("div");
          actions.className = "item-actions";

          const editBtn = document.createElement("button");
          editBtn.className = "small secondary";
          editBtn.textContent = "Edit";
          editBtn.addEventListener("click", () => {
            openItemEdit(bin, item);
          });
          actions.appendChild(editBtn);

          const delBtn = document.createElement("button");
          delBtn.className = "small danger";
          delBtn.textContent = "Remove";
          delBtn.addEventListener("click", () => {
            if (confirm(`Remove item "${item.name || "(unnamed item)"}"?`)) {
              bin.items = bin.items.filter(i => i.id !== item.id);
              upsertBin(bin);
              renderBinDetail();
            }
          });
          actions.appendChild(delBtn);

          row.appendChild(actions);

          card.appendChild(row);
        });
      }

      // NEW ITEM FORM
      const addTitle = document.createElement("div");
      addTitle.className = "section-title";
      addTitle.textContent = "Add Item";
      card.appendChild(addTitle);

      const newRow1 = document.createElement("div");
      newRow1.className = "row";

      const nNameCol = document.createElement("div");
      const nNameLabel = document.createElement("label");
      nNameLabel.textContent = "Item name";
      const nNameInput = document.createElement("input");
      nNameInput.type = "text";
      nNameInput.placeholder = "e.g. Sleeping bag";
      nNameCol.appendChild(nNameLabel);
      nNameCol.appendChild(nNameInput);
      newRow1.appendChild(nNameCol);

      const nQtyCol = document.createElement("div");
      const nQtyLabel = document.createElement("label");
      nQtyLabel.textContent = "Qty";
      const nQtyInput = document.createElement("input");
      nQtyInput.type = "number";
      nQtyInput.min = "1";
      nQtyInput.step = "1";
      nQtyInput.value = "1";
      nQtyCol.appendChild(nQtyLabel);
      nQtyCol.appendChild(nQtyInput);
      newRow1.appendChild(nQtyCol);

      card.appendChild(newRow1);

      const nNotesLabel = document.createElement("label");
      nNotesLabel.textContent = "Item notes (optional)";
      const nNotesInput = document.createElement("textarea");
      nNotesInput.placeholder = "Details, condition, where inside the bin, etc.";
      card.appendChild(nNotesLabel);
      card.appendChild(nNotesInput);

      const addItemActions = document.createElement("div");
      addItemActions.className = "inline-form-actions";

      const addItemBtn = document.createElement("button");
      addItemBtn.textContent = "Add Item";
      addItemBtn.addEventListener("click", () => {
        const name = nNameInput.value.trim();
        if (!name) {
          alert("Item name is required.");
          return;
        }
        const qty = parseInt(nQtyInput.value, 10) || 1;
        const notes = nNotesInput.value.trim();

        const newItem = {
          id: genId(),
          name,
          quantity: qty,
          notes
        };
        bin.items.push(newItem);
        bin.updatedAt = Date.now();
        upsertBin(bin);

        // reset fields
        nNameInput.value = "";
        nQtyInput.value = "1";
        nNotesInput.value = "";

        renderBinDetail();
        renderBinList(document.getElementById("search-input").value);
      });

      addItemActions.appendChild(addItemBtn);
      card.appendChild(addItemActions);

      // QR SECTION
      const qrTitle = document.createElement("div");
      qrTitle.className = "section-title";
      qrTitle.textContent = "QR Code";
      card.appendChild(qrTitle);

      const qrBox = document.createElement("div");
      qrBox.className = "qr-box";

      const qrInfo = document.createElement("div");
      qrInfo.className = "muted";
      qrInfo.style.fontSize = "0.8rem";
      qrInfo.textContent = "Scan this QR to open this bin directly.";
      qrBox.appendChild(qrInfo);

      const qrContainer = document.createElement("div");
      qrContainer.id = "qr-code";
      qrBox.appendChild(qrContainer);

      const url = buildBinUrl(bin.id);
      const urlPreview = document.createElement("div");
      urlPreview.className = "url-preview";
      urlPreview.textContent = url;
      qrBox.appendChild(urlPreview);

      const qrActions = document.createElement("div");
      qrActions.className = "inline-form-actions";

      const regenBtn = document.createElement("button");
      regenBtn.className = "secondary";
      regenBtn.textContent = "Regenerate QR";
      regenBtn.addEventListener("click", () => generateQrInto(qrContainer, url));

      const dlBtn = document.createElement("button");
      dlBtn.textContent = "Download QR PNG";
      dlBtn.addEventListener("click", () => downloadQrPng(qrContainer));

      qrActions.appendChild(regenBtn);
      qrActions.appendChild(dlBtn);
      qrBox.appendChild(qrActions);

      card.appendChild(qrBox);

      // Actually generate QR now
      generateQrInto(qrContainer, url);
    }

    function openItemEdit(bin, item) {
      const name = prompt("Item name:", item.name || "");
      if (name === null) return;
      const qtyStr = prompt("Quantity:", String(item.quantity || 1));
      if (qtyStr === null) return;
      const qty = parseInt(qtyStr, 10) || 1;
      const notes = prompt("Notes:", item.notes || "");
      if (notes === null) return;

      item.name = name.trim() || "(unnamed item)";
      item.quantity = qty;
      item.notes = notes.trim();
      bin.updatedAt = Date.now();
      upsertBin(bin);
      renderBinDetail();
      renderBinList(document.getElementById("search-input").value);
    }

    // --- QR helpers ---------------------------------------------------------

    function buildBinUrl(binId) {
      const url = new URL(window.location.href);
      url.searchParams.set("bin", binId);
      return url.toString();
    }

    function generateQrInto(container, text) {
      container.innerHTML = "";
      // QRCode.js will auto-detect canvas support
      new QRCode(container, {
        text,
        width: 160,
        height: 160,
        correctLevel: QRCode.CorrectLevel.M
      });
    }

    function downloadQrPng(container) {
      const canvas = container.querySelector("canvas");
      const img = container.querySelector("img");

      let dataUrl;
      if (canvas) {
        dataUrl = canvas.toDataURL("image/png");
      } else if (img && img.src) {
        dataUrl = img.src;
      } else {
        alert("QR not generated yet.");
        return;
      }

      const a = document.createElement("a");
      a.href = dataUrl;
      a.download = "bin-qr.png";
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    // --- URL param handling --------------------------------------------------

    function getBinIdFromUrl() {
      try {
        const url = new URL(window.location.href);
        return url.searchParams.get("bin");
      } catch (e) {
        return null;
      }
    }

    function openBinDetail(id) {
      currentBinId = id;
      showView("view-detail");
      renderBinDetail();
    }

    // --- New bin flow -------------------------------------------------------

    function newBinFlow() {
      const name = prompt("Bin name / label (e.g. 'Bin 01 – Tools'):");
      if (name === null) return;
      const location = prompt("Location (optional):", "");
      if (location === null) return;
      const notes = prompt("Notes (optional):", "");

      const bin = {
        id: genId(),
        name: name.trim() || "(Untitled bin)",
        location: location ? location.trim() : "",
        notes: notes ? notes.trim() : "",
        items: [],
        createdAt: Date.now(),
        updatedAt: Date.now()
      };

      upsertBin(bin);
      renderBinList(document.getElementById("search-input").value);
      openBinDetail(bin.id);
    }

    // --- Init ---------------------------------------------------------------

    document.addEventListener("DOMContentLoaded", () => {
      loadBins();
      renderBinList();

      const searchInput = document.getElementById("search-input");
      searchInput.addEventListener("input", () => {
        renderBinList(searchInput.value);
      });

      document.getElementById("add-bin-btn").addEventListener("click", newBinFlow);

      document.getElementById("back-to-list").addEventListener("click", () => {
        currentBinId = null;
        showView("view-list");
        // don't clear ?bin param; scanning again will still work and that's fine
      });

      // Deep-link via ?bin=...
      const deepBinId = getBinIdFromUrl();
      if (deepBinId) {
        const bin = findBin(deepBinId);
        if (bin) {
          openBinDetail(deepBinId);
        } else {
          // If bin not found (e.g., first time after scanning), just show list.
          showView("view-list");
        }
      } else {
        showView("view-list");
      }
    });
  </script>
</body>
</html>
